<html>
<head>
<meta charset="UTF-8">
<title>업타임 표시 API</title>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript">

//쿼리 값 읽어오는 함수
function getQueryVariable(variable){
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}

$(document).ready(function(){
	//쿼리 값으로 유저네임 미입력 시 사용례 출력
	if(getQueryVariable("username")==false){
	$("#output").html("사용례:".bold()+" ~/uptime/ko.html?username="+"아이디".italics());
	}
	//쿼리 값으로 유저네임 입력했을 경우
	else{
		//v5 API 사용을 위한 ID를 긁어오기 위해 쿼리 값으로 얻은 유저네임으로 유저 프로필 읽어오기 
		var idCheckUrl="https://api.twitch.tv/kraken/users?login="+getQueryVariable("username")+"&client_id=0gh9o9fest4sn1ohihvdpf6djdojdn&api_version=5";
		$.getJSON(idCheckUrl,function(dataIn){
			var userId=dataIn.users[0]._id;
			//유저 프로필에서 ID 긁어와서 v5 API에 사용하여 스트림 정보 읽어오기
			var url="https://api.twitch.tv/kraken/streams/"+userId+"?client_id=0gh9o9fest4sn1ohihvdpf6djdojdn&api_version=5";
			$.getJSON(url,function(dataOut){
				//스트림 오프라인일 경우 메시지 출력
				if(dataOut.stream===null){
					$("#output").html("현재 방송 중이지 않습니다.");
				}
				//스트림 온라인일 경우 created_at과 현재 시간으로 업타임 계산
				else{
					var nowDate=new Date();
					var startDate=new Date(dataOut.stream.created_at);
					var dateGap = nowDate.getTime() - startDate.getTime();
					var timeGap = new Date(0, 0, 0, 0, 0, 0, nowDate - startDate);	  
					var diffDay  = Math.floor(dateGap / (1000 * 60 * 60 * 24));   
					var diffHour = timeGap.getHours();
					var diffMin  = timeGap.getMinutes();
					var diffSec  = timeGap.getSeconds();
					var uptime = "현재"
					if(diffDay>0) uptime+=" "+diffDay+"일";
					if(diffHour>0) uptime+=" "+diffHour+"시간";
					if(diffMin>0) uptime+=" "+diffMin+"분";
					if(diffSec>0) uptime+=" "+diffSec+"초";
					uptime+=" 동안 방송 중입니다.";
					$("#output").html(uptime);
				}
			})
		})
	}
})
	
</script>
</head>
<body>
<h id="output"></h>
</body>
</html>
